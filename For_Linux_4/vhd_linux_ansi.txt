
VHD Диски в Linux.

Всех интересует вопрос, как же использовать VHD диски в Linux.
Ведь мо умолчанию их поддерживает только windows.
Сегодня мы с вами решим эту проблему раз и навсегда вместе и поможет нам в этом - всемогущий QEMU.
Для начала, необходимо установить пакет nbd. Ядро будет подгружать его модули, а qemu-nbd будет их использовать.

$ sudo pacman -S nbd --noconfirm

Далее необходимо загрузить модули ядра nbd:

$ sudo modprobe nbd

Определимся с размером виртуального диска. Пусть будет 4ГБ.

$ qemu-img create -f vpc -o size=4G ./test.vhd

Образ диска мы создали. Однако надо понимать, что это формат vpc, т.е. vhd. И работать с ним надо уже совершенно иначе, чем с форматом raw (например образ dd).

Чтобы работать с этим диском, его сначала надо подключить к системе в качестве диска:

$ qemu-nbd -c /dev/nbd0 ./test.vhd

Вот теперь у нас в системе появилось новое устройство - nbd0.
Теперь мы и должны в этом устройстве создать новую таблицу разделов и затем уже сами разделы. Для этого можно воспользоваться следующими утилитами: parted, cfdisk, fdisk, gparted и другие. Я же воспользуюсь GParted и создам таблицу разделов типа msdos, а затем один единственный раздел с типом FAT32. И сразу же отформатирую в FAT32.
Чтобы утилита непосредственно работала с нужным нам диском просто наберите её и следом в консоли через пробел укажите нужный вам диск. В данном случае:

$ sudo gparted /dev/nbd0

Или

$ cfdisk /dev/nbd0

Не забываем проверить созданные разделы. Теперь они должны быть видны:

$ lsblk

После того, как создали все необходимые разделы, их необходимо куда-то смонтировать.

$ mkdir -p ./disk

Наше отформатированное устройство будет вести себя как полноценный жесткий диск, поэтому мы можем смонтировать любой раздел этого жесткого диска куда нам заблагорассудится в нужном нам порядке. У меня для этого уже создан каталог.

$ id -g mikl
$ id -u mikl
$ sudo mount -t auto -o,rw,gid=985,uid=1000 /dev/nbd0p1 ./disk

И только после этого мы можем работать с этим разделом как с полноценным разделом жесткого диска.
А вот здесь стоит обратить внимание на то, что запись в виртуальный диск, к сожалению, происходит только от имени суперпользователя. Простой пользователь просто получит ошибку записи. Однако если вы используете тип раздела ext подобные, например ext4, то просто создайте внутри отдельную папку и дайте ей права пользователя. Теперь в эту папку может записывать данные любой пользователь.

$ sudo umount -l ./disk

Затем отсоединить наш виртуальный диск от блочного устройства, т.е. грубо говоря отмонтировать, но специальной командой:

$ sudo qemu-nbd -d /dev/nbd0

Всё, можем подключать этот диск к виртуальной машине, например на VirtualBox. Я же загружу образ WinPE для проверки работоспособности этого виртуального диска.
На скриншоте можете видеть результат проделанной работы.
Всё, можем радоваться жизни.
Удачи!



